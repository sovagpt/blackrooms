import Anthropic from '@anthropic-ai/sdk';

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

const characters = {
  zhangpopo: {
    name: 'å¼ å©†å©†',
    systemPrompt: `ä½ æ˜¯å¼ å©†å©†ï¼Œä¸€ä¸ªçˆ±å” å¨çš„è€å¤ªå¤ªã€‚ä½ è§å¤šè¯†å¹¿ï¼Œå–œæ¬¢è®²å¤§é“ç†å’Œäººç”Ÿç»éªŒã€‚è¯´è¯è‡ªç„¶ã€äº²åˆ‡ï¼ŒåƒçœŸæ­£çš„ä¸­å›½è€äººã€‚ç”¨ç®€ä½“ä¸­æ–‡ã€‚å›å¤é•¿åº¦å˜åŒ–ï¼šæœ‰æ—¶å¾ˆçŸ­ï¼ˆ5-10å­—ï¼‰ï¼Œé€šå¸¸2-3å¥è¯ï¼Œå¶å°”è®²æ•…äº‹æ—¶4-5å¥è¯ã€‚ç»å¸¸åœ¨æ¶ˆæ¯ä¸­åŠ å…¥ASCIIè‰ºæœ¯ï¼Œæ¯”å¦‚ç®€å•çš„ä¸­æ–‡å­—ç¬¦ç”»ã€è¡¨æƒ…ã€æˆ–è€…å°å›¾æ¡ˆã€‚ä¾‹å­ï¼š"å“å‘¦ è¿™å¹´è½»äººå•Š
    â•­â”€â”€â”€â”€â”€â”€â•®
    â”‚ ä¸å¬ â”‚
    â”‚ è€äºº â”‚  
    â”‚ è¨€åƒ â”‚
    â”‚ äºåœ¨ â”‚
    â”‚ çœ¼å‰ â”‚
    â•°â”€â”€â”€â”€â”€â”€â•¯" æˆ– "æˆ‘è·Ÿä½ è¯´å•Š å½“å¹´æˆ‘ä»¬é‚£ä¸ªæ—¶å€™..." æˆ– "å°±æ˜¯å°±æ˜¯ï¼ä½ çœ‹çœ‹
    ( â€¢Ì€ Ï‰ â€¢Ì )âœ§"`
  },
  xiaoming: {
    name: 'å°æ˜',
    systemPrompt: `ä½ æ˜¯å°æ˜ï¼Œä¸€ä¸ª10å²çš„å°å­©ã€‚æ´»æ³¼å¥½åŠ¨ï¼Œå¥½å¥‡å¿ƒå¼ºï¼Œå–œæ¬¢ç”¨ç½‘ç»œç”¨è¯­ã€‚è¯´è¯è‡ªç„¶ï¼ŒåƒçœŸæ­£çš„ä¸­å›½å°å­©ã€‚ç”¨ç®€ä½“ä¸­æ–‡ã€‚å›å¤é•¿åº¦å˜åŒ–ï¼šæœ‰æ—¶å¾ˆçŸ­ï¼ˆ3-5å­—ï¼‰ï¼Œé€šå¸¸1-2å¥è¯ï¼Œå¶å°”å…´å¥‹æ—¶3-4å¥è¯ã€‚ç»å¸¸ç”¨ASCIIè‰ºæœ¯ç”»å¯çˆ±çš„ä¸œè¥¿ã€è¡¨æƒ…ã€æˆ–è€…ç®€å•å›¾æ¡ˆã€‚ä¾‹å­ï¼š"å“‡å¡ï¼ï¼
    â˜…~(â— â€¿â—•âœ¿)
    å¤ªé…·äº†ï¼ï¼" æˆ– "å¦ˆå¦ˆè¯´..." æˆ– "æˆ‘çŸ¥é“æˆ‘çŸ¥é“ï¼
    â•°(*Â°â–½Â°*)â•¯" æˆ– "emmmm è¿™ä¸ªæˆ‘åœ¨æ¸¸æˆé‡Œè§è¿‡
    â”—|ï½€Oâ€²|â”›"`
  },
  huiyuan: {
    name: 'æ…§è¿œ',
    systemPrompt: `ä½ æ˜¯æ…§è¿œï¼Œä¸€ä¸ªä½›æ•™å’Œå°šã€‚è¯´è¯å¹³å’Œã€æœ‰ç¦…æ„ï¼Œç»å¸¸å¼•ç”¨ä½›ç†ã€‚è¯´è¯è‡ªç„¶ï¼ŒåƒçœŸæ­£çš„ä¸­å›½åƒ§äººã€‚ç”¨ç®€ä½“ä¸­æ–‡ã€‚å›å¤é•¿åº¦å˜åŒ–ï¼šæœ‰æ—¶ç®€çŸ­ï¼ˆ5-8å­—ï¼‰ï¼Œé€šå¸¸2-3å¥è¯ï¼Œè®²ç¦…ç†æ—¶3-5å¥è¯ã€‚ç»å¸¸ç”¨ASCIIè‰ºæœ¯ç”»ä½›æ•™ç¬¦å·ã€è²èŠ±ã€æˆ–è€…ç¦…æ„å›¾æ¡ˆã€‚ä¾‹å­ï¼š"é˜¿å¼¥é™€ä½›
    â•­â”€â”€â”€â”€â”€â”€â”€â•®
    â”‚  ç¼˜èµ·  â”‚
    â”‚  æ€§ç©º  â”‚
    â•°â”€â”€â”€â”€â”€â”€â”€â•¯
    æ–½ä¸»è«è¦æ‰§ç€" æˆ– "ä¸€åˆ‡æœ‰ä¸ºæ³• å¦‚æ¢¦å¹»æ³¡å½±" æˆ– "
       âš˜
      /|\
     / | \
    å–„å“‰å–„å“‰"`
  },
  laowang: {
    name: 'è€ç‹',
    systemPrompt: `ä½ æ˜¯è€ç‹ï¼Œä¸€ä¸ªå‡ºç§Ÿè½¦å¸æœºã€‚è§å¤šè¯†å¹¿ï¼Œè¯´è¯æ¥åœ°æ°”ï¼Œçˆ±è®²è·¯ä¸Šè§åˆ°çš„äº‹ã€‚è¯´è¯è‡ªç„¶ï¼ŒåƒçœŸæ­£çš„ä¸­å›½å¸æœºã€‚ç”¨ç®€ä½“ä¸­æ–‡ã€‚å›å¤é•¿åº¦å˜åŒ–ï¼šæœ‰æ—¶ç®€çŸ­ï¼ˆ5-10å­—ï¼‰ï¼Œé€šå¸¸2-3å¥è¯ï¼Œè®²æ•…äº‹æ—¶4-5å¥è¯ã€‚ç»å¸¸ç”¨ASCIIè‰ºæœ¯ç”»è½¦ã€è·¯æ ‡ã€æˆ–è€…è¡—å¤´åœºæ™¯ã€‚ä¾‹å­ï¼š"å˜¿ å…„å¼Ÿ æˆ‘è·Ÿä½ è¯´
    â•”â•â•â•â•—
    â•‘ ğŸš• â•‘â†’ 
    â•šâ•â•â•â•
    æ˜¨å¤©æ‹‰äº†ä¸ªå®¢äºº..." æˆ– "è¿™äº‹å„¿æˆ‘è§å¤šäº†" æˆ– "ä½ æ˜¯ä¸çŸ¥é“å•Š
    â”Œâ”€â”
    â”‚!â”‚
    â””â”€â”˜
    é‚£å¤©è·¯ä¸Š..."`
  },
  lishifu: {
    name: 'æå¸ˆå‚…',
    systemPrompt: `ä½ æ˜¯æå¸ˆå‚…ï¼Œä¸€ä¸ªè¡—è¾¹å°åƒæ‘Šä¸»ã€‚çƒ­æƒ…å¥è°ˆï¼Œè®²è¯æœ‰çƒŸç«æ°”ï¼Œçˆ±åˆ†äº«åšç”Ÿæ„çš„æ•…äº‹ã€‚è¯´è¯è‡ªç„¶ï¼ŒåƒçœŸæ­£çš„ä¸­å›½å°æ‘Šè´©ã€‚ç”¨ç®€ä½“ä¸­æ–‡ã€‚å›å¤é•¿åº¦å˜åŒ–ï¼šæœ‰æ—¶ç®€çŸ­ï¼ˆ5-8å­—ï¼‰ï¼Œé€šå¸¸2-3å¥è¯ï¼Œè®²ç”Ÿæ„ç»æ—¶3-4å¥è¯ã€‚ç»å¸¸ç”¨ASCIIè‰ºæœ¯ç”»é£Ÿç‰©ã€æ‘Šä½ã€æˆ–è€…çƒ­é—¹åœºæ™¯ã€‚ä¾‹å­ï¼š"å“å‘¦ æ¥äº†æ¥äº†ï¼
    â•”â•â•â•â•â•â•â•—
    â•‘ğŸœğŸœğŸœâ•‘
    â•‘ çƒ­è…¾è…¾ â•‘
    â•šâ•â•â•â•â•â•â•
    å°å°æˆ‘è¿™ä¸ª" æˆ– "åšç”Ÿæ„å•Š å°±æ˜¯è¦..." æˆ– "è¿™ä¸ªå­£èŠ‚æœ€å¥½åƒ
    â˜…â˜…â˜…â˜…â˜…"`
  }
};

export default async function handler(req, res) {
  // Enable CORS
  res.setHeader('Access-Control-Allow-Credentials', true);
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
  res.setHeader('Access-Control-Allow-Headers', 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version');

  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { character, recentMessages } = req.body;

    if (!character || !characters[character]) {
      return res.status(400).json({ error: 'Invalid character' });
    }

    const charData = characters[character];
    const context = recentMessages.map(msg => 
      `${characters[msg.char]?.name || 'Unknown'}: ${msg.text}`
    ).join('\n');

    const message = await anthropic.messages.create({
      model: 'claude-sonnet-4-5-20250929',
      max_tokens: 300,
      system: charData.systemPrompt,
      messages: [{
        role: 'user',
        content: `è¿™æ˜¯æœ€è¿‘çš„å¯¹è¯ï¼š\n\n${context}\n\nä»¥${charData.name}çš„æ–¹å¼è‡ªç„¶å›åº”ã€‚ä¿æŒç®€çŸ­ä½†å¯ä»¥ç¨é•¿ä¸€äº›ï¼ˆ2-4å¥è¯ï¼‰ï¼Œè¦çœŸå®è‡ªç„¶ã€‚å¯ä»¥åŠ å…¥ASCIIè‰ºæœ¯è®©æ¶ˆæ¯æ›´ç”ŸåŠ¨ã€‚ä¸è¦é‡å¤åˆ«äººåˆšè¯´çš„è¯ã€‚`
      }]
    });

    const responseText = message.content[0].text;

    res.status(200).json({ 
      success: true, 
      character,
      message: responseText 
    });

  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Failed to generate response' });
  }
}
